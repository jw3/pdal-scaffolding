#!/usr/bin/env bash

readonly srcdir="$PWD"
readonly name="cmake-build-MyPlugin"
readonly root="$srcdir/$name"

rm -rf "$root"

mkdir -p "$root/build"
mkdir -p "$root/scaffolding"

cd "$root/scaffolding"

cmake \
-DPLUGIN_TYPE="filter" \
-DPLUGIN_NAME="MyPlugin" \
-DPLUGIN_NAMESPACE="jw3" \
-DTARGET_DIR="$root" \
-DCXX_STANDARD="14" \
-DMAJOR_VERSION=1 \
-DMINOR_VERSION=0 \
-DPATCH_VERSION=0 \
"$srcdir" > /dev/null

cd "$root/build"
pwd
conan install "$root"
cmake -DCPACK_PACKAGE_CONTACT="$USER" -DCPACK_GENERATOR="DEB;STGZ;TGZ;RPM" "$root"
make package

conan export-pkg .. jw3/test -f

mkdir conan
cd conan
conan install -g txt MyPlugin/1.0.0@jw3/test

export PDAL_DRIVER_PATH=$(cat conanbuildinfo.txt | grep MyPlugin | grep 'lib$' | head -n1)
echo "testing driver path at $PDAL_DRIVER_PATH"

if [[ ! -z $(pdal --drivers | grep jw3_MyPlugin) ]]; then
  echo "Success!"
  exit 0;
else
  echo "Failure!"
  exit 1;
fi
